<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rasper Revision</title>

  <!-- FAVICON -->
  <link rel="icon" type="image/png" href="/assets/favicon.png">

  <!-- BOOTSTRAP STYLES -->
  <link href="/node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

  <!-- BOOTSTRAP SCRIPTS-->
  <script src="/node_modules/bootstrap/dist/js/bootstrap.bundle.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"
    defer></script>

  <!-- BOOTSTRAP ICONS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- STYLES -->
  <link href="/style.css" rel="stylesheet">

  <style>
    body {
      height: 100vh;
    }

    .container {
      max-width: 600px;
      border-radius: 10px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.9);
    }
  </style>
</head>

<body class="flex align-items-center justify-content-center">
  <ul class="nav nav-pills position-absolute top-0 p-2 m-3">
    <li class="nav-item">
      <a class="nav-link text-white" href="/fill-in-the-blank/?json=macbeth.json">Macbeth</a>
    </li>
    <li class="nav-item">
      <a class="nav-link text-white" href="/fill-in-the-blank/?json=christmas_carol.json">A Christmas Carol</a>
    </li>
    <li class="nav-item">
      <a class="nav-link text-white" href="/fill-in-the-blank/?json=coldwarquotes.json">Cold War</a>
    </li>
  </ul>

  <div class="container w-100 bg-light p-4">
    <h3 class="mb-4" style="color: black">Complete the quotation</h3>
    <div class="fw-bold" id="themes" style="color: black"></div>
    <div class="fs-5 mb-4" id="quote" style="color: black"></div>

    <input class="form-control p-2 mb-3" type="text" id="input" placeholder="Enter your guess" autocomplete="off"
      style="color: black">

    <button class="rbtn primary" id="submit-btn">Submit</button>
    <button class="rbtn warning invis" id="next-btn">Next</button>

    <div class="my-2" id="result" style="color: black"></div>
  </div>


  <script src="/sidebar.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]o]()-=+.$@#%^&*/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"), results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
      }

      function loadJSON(callback) {
        var jsonFile = getParameterByName('json');
        var xobj = new XMLHttpRequest();
        xobj.overrideMimeType("application/json");
        xobj.open('GET', jsonFile, true);
        xobj.onreadystatechange = function () {
          if (xobj.readyState == 4 && xobj.status == 200) { callback(JSON.parse(xobj.responseText)); }
        };
        xobj.send(null);
      }

      function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      const themesElement = document.getElementById("themes");
      const quoteElement = document.getElementById("quote");
      const inputElement = document.getElementById("input");
      const submitButton = document.getElementById("submit-btn");
      const nextButton = document.getElementById("next-btn");
      const resultElement = document.getElementById("result");
      const pills = document.querySelectorAll('.nav-link');

      let quotes;
      let shuffledQuotes;
      let currentQuoteIndex = 0;

      function displayQuote() {
        const quoteObj = shuffledQuotes[currentQuoteIndex];
        const themesTitleCase = quoteObj.themes.map(theme => toTitleCase(theme));
        themesElement.textContent = `${themesTitleCase.join(", ")}`;
        quoteElement.textContent = maskQuote(quoteObj.quote);
      }

      function toTitleCase(str) {
        return str.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
      }

      function maskQuote(quote) {
        return quote.replace(/\b\w+(?:[']\w+)?|[^\s]/g, match => {
          if (match.trim() === "") return match;
          if (/[^a-zA-Z]/.test(match)) return match;
          if (Math.random() < 0.4) return "_".repeat(match.length);
          else return match;
        });
      }

      function removePunctuation(text) {
        return text.replace(/[.,\/#!$%\^&\*;:{}=\-_~()]/g, "").replace(/\s{2,}/g, " ");
      }

      function checkInput() {
        const userGuess = removePunctuation(inputElement.value.trim());
        const actualQuote = shuffledQuotes[currentQuoteIndex].quote;
        resultElement.textContent = (userGuess.toLowerCase() === removePunctuation(actualQuote.toLowerCase())) ? "Correct!" : "Incorrect. The correct quote is: " + actualQuote;
        resultElement.classList.add((userGuess.toLowerCase() === removePunctuation(actualQuote.toLowerCase())) ? 'alert-success' : 'alert-danger');
        submitButton.classList.add('invis');
        nextButton.classList.remove('invis');
      }

      function nextQuote() {
        currentQuoteIndex++;
        if (currentQuoteIndex >= shuffledQuotes.length) {
          currentQuoteIndex = 0;
          shuffledQuotes = shuffle([...quotes]);
        }
        inputElement.value = "";
        resultElement.textContent = "";
        submitButton.classList.remove('invis');
        nextButton.classList.add('invis');
        displayQuote();
      }

      submitButton.addEventListener("click", function () { checkInput(); });
      nextButton.addEventListener("click", function () { nextQuote(); });

      inputElement.addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
          event.preventDefault();
          if (nextButton.classList.contains('invis')) { checkInput(); }
          else { nextQuote(); }
        }
      });

      loadJSON(function (response) {
        quotes = response;
        shuffledQuotes = shuffle([...quotes]);
        console.log(shuffledQuotes);
        displayQuote();

        const jsonFileName = getParameterByName('json');
        pills.forEach(pill => {
          if (pill.getAttribute('href').includes(jsonFileName)) {
            pill.classList.add('active');
          }
        });
      });
    });

  </script>
</body>

</html>