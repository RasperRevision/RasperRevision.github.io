<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Search the Rasper Revision site." />
    <title>Search - Rasper Revision</title>

    <!-- BREADCRUMB LIST -->

    <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "BreadcrumbList",
            "itemListElement": [
                {
                    "@type": "ListItem",
                    "position": 1,
                    "name": "Search"
                }
            ]
        }
    </script>

    <!-- FAVICON -->
    <link rel="icon" type="image/png" href="/assets/favicon.png" />

    <!-- BOOTSTRAP STYLES -->
    <link href="/node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- BOOTSTRAP SCRIPTS-->
    <script src="/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- STYLES -->
    <link href="/style.css" rel="stylesheet" />
</head>
<body>
    <div class="main_wrapper">
        <main class="container">
            <input class="w-100 search_field">
            <div class="search_results">
        </main>
    </div>
    <script>
        const puppeteer = require('puppeteer');
        
        async function fetchSitemap() {
            const response = await fetch('/sitemap.xml');
            const sitemap = await response.text();
            const doc = new DOMParser().parseFromString(sitemap, "text/xml");
        
            const urls = Array.from(doc.querySelectorAll("loc")).map(child => child.textContent);
        
            return urls;
        }
        
        async function fetchPageTitles(urls) {
            const urlTitlePairs = [];
            const browser = await puppeteer.launch();
        
            for (const url of urls) {
                try {
                    const page = await browser.newPage();
                    await page.goto(url, { waitUntil: 'networkidle0' });
        
                    const title = await page.title();
        
                    urlTitlePairs.push({ url, title });
                    await page.close(); 
        
                } catch (error) {
                    console.error(`Failed to fetch ${url}: ${error}`);
                    urlTitlePairs.push({ url, title: 'Error fetching title' });
                }
            }
        
            await browser.close();
        
            return urlTitlePairs;
        }
        
        (async () => {
            const urls = await fetchSitemap();
            const urlTitlePairs = await fetchPageTitles(urls);
        
            urlTitlePairs.forEach(({ url, title }) => {
                document.querySelector('.search_results').innerHTML += `<a href="${url}">${title}</a>`;
            });
        })();

    </script>
    <script src="/sidebar.js"></script>
</body>
</html>
